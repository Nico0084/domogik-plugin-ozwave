{% block content %}
<h3></h3>
<div class="contenaire-fluid">
       <table id="tabnodes_{{ network_active }}" class="display cell-border" cellspacing="0" width="100%">
                          <thead>
                            <tr>
                              <th>Node</th>
                              <th>Name</th>
                              <th>Location</th>
                              <th>Model</th>
                              <th>Awake</th>
                              <th>Type</th>
                              <th>LastUpdate</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                        <tbody>
                        {% for node in nodes_state %}
                            <tr>
                                <td id="node-{{ node.NodeID }}">
                                    {{ node.NetworkID }}.{{ node.NodeID }}
                                </td>
                                <td>{{ node.Name }}</td>
                                <td>{{ node.Location }}</td>
                                <td>{{ node.Model }}</td>
                                <td>{{ node["State sleeping"] }}</td>
                                <td>{{ node.Type }}</td>
                                <td>{{ node["Last update"] }}</td>
                                <td>Actions...</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
</div>

<script type='text/javascript'>

    $(document).ready(function(){
        $.fn.bootstrapSwitch.defaults.size = 'mini'; //override the default options of the bootstrap-switch library
        nodesData = {{ nodes_state|tojson }}
        $("[id^='tabnodes_']").DataTable({
        "paging":   true,
        "ordering": true,
        "order": [[ 0, "asc" ]],
        "lengthMenu": [[20, 35, 50, -1], [20, 35, 50, "All"]],
        "info": true,
        "columnDefs": [{
            "targets": 0,
            "render": function (data, type, full, meta) {return renderNodeStatusCol(data, type, full, meta);}
            },{
            "targets": 1,
            "width": "15%",
            "render": function (data, type, full, meta) {return renderNodeNameCol(data, type, full, meta);}
            },{
            "targets": 2,
            "width": "15%",
            "render": function (data, type, full, meta) {return renderNodeLocationCol(data, type, full, meta);}
            },{
            "targets": 4,
            "render": function (data, type, full, meta) {return renderNodeAwakeCol(data, type, full, meta);}
            },{
            "targets": 5,
            "render": function (data, type, full, meta) {return renderNodeTypeCol(data, type, full, meta);}
            },{
            "targets": 7,
            "render": function (data, type, full, meta) {return renderNodeActionColl(data, type, full, meta);}
            }
          ],
        "drawCallback": function(settings) {
            var api = this.api();
            var data = api.rows({page:'current'}).data()
            $("[data-toggle = 'popover']").popover({
                                html:true,
                                trigger:'hover click'
                            });
            $('[data-toggle="tooltip"]').tooltip({
                                html:true
                            });
            $(document).on("click", ".popover .close" , function(){
                $(this).parents(".popover").popover('hide');
            });
            $( "input[type='text'][datatype='node']").not("[isHandled]" ).each(function(rowN, nData) {
                try {
                    var cell = api.cell(rowN, 0);
                    var obj = this
                    EnableInputText(this, function(e) {
                        var value = obj.value;
                        var refId =  obj.id.split("_");
                        var NetworkID = refId[1];
                        var NodeID = refId[2];
                        var name = obj.name;
                        sendRequest("ozwave.node.set", {"networkId": NetworkID, "nodeId": NodeID, "key": name, "value": value}, function(data, result) {
                             if (result == "error" || data.result == "error") {
                                    new PNotify({
                                        type: 'error',
                                        title: 'Set ' + name + ' fail.',
                                        text: data.content.error,
                                        delay: 6000
                                    });
                                } else {
                                    new PNotify({
                                            type: 'success',
                                            title: 'Set ' + name + ' ok.',
                                            text: 'node ' + data.content.NodeID + ' named : ' + data.content.Name + ', location : ' + data.content.Location,
                                            delay: 4000
                                    });
                                };
                            });
                        // send update to ws
                        //return {"result":"succes", "value":value, "msg": "bad format"};
                    });
                }
                catch (err) {
                    console.log(err);
                };
            });
            $(".btn[type='nodeaction']").not("[isHandled]" ).each(function(rowN, nData) {
                try {
                    var cell = api.cell(rowN, 0);
                    EnableButtonAction(this, function(obj) {
                        var value = obj.value;
                        var refId =  obj.id.split("_");
                        var NetworkID = refId[1];
                        var NodeID = refId[2];
                        var action = "";
                        var nodeData = GetZWNode(refId[1], refId[2]);
                        switch (refId[0]) {
                            case "monitornode" :
                                requestNodeMonitoring(nodeData);
                                break;
                            case "refreshnode" :
                                DialBoxRequestRefreshNode(nodeData);
                                break;
                            case "detailnode" :
                                var tr = $(obj).closest('tr');
                                var row = api.row(tr);
                                var nodeRefId = GetNodeRefId(NetworkID, NodeID);
                                if ($('#valuesNode'+nodeRefId).length != 0) {
                                    row.child.remove();
                                    $('#detailnodeic'+nodeRefId).removeClass('fa-search-minus fa-spinner fa-spin').addClass('fa-search-plus');
                                } else {
                                    $('#detailnodeic'+nodeRefId).removeClass('fa-search-minus fa-search-plus').addClass('fa-spinner fa-spin');
                                    sendRequest("ozwave.node.get", {"key": "values", "networkId": NetworkID, "nodeId": NodeID}, function(data, result) {
                                        var nodeRefId = GetNodeRefId(data.content.NetworkID, data.content.NodeID);
                                        if (result == "error" || data.result == "error") {
                                            if ($('#valuesNode'+nodeRefId).length != 0) {
                                                $('#detailnodeic'+nodeRefId).removeClass('fa-search-plus fa-spinner fa-spin').addClass('fa-search-minus');
                                            } else {
                                                $('#detailnodeic'+nodeRefId).removeClass('fa-search-minus fa-spinner fa-spin').addClass('fa-search-plus');
                                            }
                                            new PNotify({
                                                type: 'error',
                                                title: 'Get list of command class value fail.',
                                                text: data.content.error,
                                                delay: 6000
                                            });
                                        } else {
                                            RefreshValuesNodeData(data.content.NetworkID, data.content.NodeID, data.content.Values);
                                            row.child(initValuesTab(nodeRefId)).show();
                                            buildValuesTab(data.content);
                                            $('#valuesNode'+nodeRefId +' thead tr').addClass("headcmdclss");
                                            $('#detailnodeic'+nodeRefId).removeClass('fa-search-plus fa-spinner fa-spin').addClass('fa-search-minus');
                                        };
                                    });
                                };
                                break;
                            case "updassoc" :
                                openDialogAssoc(nodeData);
                                break;
                        };
                        // send update to ws
                        return {"result":"success", "value":value, "msg": "bad format"};
                    });
                }
                catch (err) {
                    console.log(err);
                };
            });
            $( "[id^='nodedmgdevices']").not("[isHandled]" ).each(function(rowN, nData) {
                EnableButtonAction(this, function(obj) {
                    $("[id^='refrechDetectDev_']").not("[isHandled]" ).each(function(rowN, nData) {
                        EnableButtonAction(this, function(obj) {
                            var refId =  obj.id.split("_");
                            var NetworkID = refId[1];
                            var NodeID = refId[2];
                            var nodeRefId = GetNodeRefId(NetworkID, NodeID);
                            $("#refrechDetectDev-ic"+nodeRefId).removeClass().addClass("fa fa-refresh fa-spin");
                            sendRequest("ozwave.node.action", {"action": "RefrechDetectDev", "networkId": refId[1], "nodeId": refId[2]}, function(data, result) {
                                var nodeRefId = GetNodeRefId(data.content.NetworkID, data.content.NodeID);
                                $("#refrechDetectDev-ic"+nodeRefId).removeClass().addClass("fa fa-refresh");
                                $("#refrechDetectDev"+nodeRefId).parents('.popover').hide();
                                if (result == "error" || data.result == "error") {
                                    new PNotify({
                                        type: 'error',
                                        title: 'Action fail',
                                        text: 'Refreshing linked domogik device.',
                                        delay: 6000
                                    });
                                } else {
                                    new PNotify({
                                            type: 'success',
                                            title: 'Action sended',
                                            text: 'Wait for result of refreshing linked domogik device ...',
                                            delay: 4000
                                    });
                                };
                            });
                        });
                    });
                });
            });
            $( "input[type='checkbox'][id^='batcheck']").not("[isHandled]" ).each(function(rowN, nData) {
                $(this).attr("isHandled", true);
                $(this).on('change', function (e) {
                    var refId = this.id.split('_');
                    var state = $(this).is(':checked');
                    sendRequest("ozwave.node.action", {"action": "batterycheck", "networkId": refId[1], "nodeId": refId[2], "state": state}, function(data, result) {
                        var nodeRefId = GetNodeRefId(data.content.NetworkID, data.content.NodeID);
                        var nodeData = GetZWNode(data.content.NetworkID, data.content.NodeID);
                        if (result == "error" || data.result == "error") {
                            new PNotify({
                                type: 'error',
                                title: 'Set battery checking at wakeup fail.',
                                text: data.content.error,
                                delay: 6000
                            });
                        } else {
                            nodeData.BatteryChecked = data.content.state;
                            RefreshDataNode(nodeData);
                            var table = $("#tabnodes_" + data.content.NetworkID).DataTable();
                            var cell = GetNodeCell(table, data.content.NodeID, 0);
                            HighlightCell(cell.node());
                        };
                        if (nodeData.BatteryChecked) {$('#batcheck'+nodeRefId).attr("title","Battery level is requested at each awake.").prop('checked', true);
                        } else { $('#batcheck'+nodeRefId).attr("title","Check to request battery level at each awake.").prop('checked', false);};
                    });
                });
            });
          }
        });
    });

</script>

 {% endblock %}
